# Docker Build Optimization Guide

## üöÄ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å–±–æ—Ä–∫–∏ Docker –æ–±—Ä–∞–∑–æ–≤

### –û—Å–Ω–æ–≤–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:

#### 1. **BuildKit –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**
- –í–∫–ª—é—á–µ–Ω `DOCKER_BUILDKIT=1` –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥ —Å–±–æ—Ä–∫–∏
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–æ–µ–≤
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –º–µ–∂–¥—É —Å–±–æ—Ä–∫–∞–º–∏

#### 2. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ Dockerfile**
- **Frontend**: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ pnpm store –∏ Next.js cache
- **Backend**: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ bun cache –∏ Prisma cache
- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

#### 3. **–ù–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã Makefile**

##### Development:
```bash
make dev-build-fast    # –ë—ã—Å—Ç—Ä–∞—è —Å–±–æ—Ä–∫–∞ (—Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Å–ª–æ–∏)
make dev-build         # –ü–æ–ª–Ω–∞—è —Å–±–æ—Ä–∫–∞ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
```

##### Production:
```bash
make prod-build-fast   # –ë—ã—Å—Ç—Ä–∞—è —Å–±–æ—Ä–∫–∞ (—Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Å–ª–æ–∏)
make prod-build        # –ü–æ–ª–Ω–∞—è —Å–±–æ—Ä–∫–∞ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
make prod-build-sequential  # –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ –¥–ª—è –º–∞–ª–æ–º–æ—â–Ω—ã—Ö —Å–∏—Å—Ç–µ–º
```

##### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–µ–º:
```bash
make cache-clean       # –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ Docker –∫—ç—à–∏
make cache-inspect     # –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫—ç—à–∞—Ö
```

### üìä –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:

#### –í—Ä–µ–º—è —Å–±–æ—Ä–∫–∏:
- **–ü–µ—Ä–≤–∞—è —Å–±–æ—Ä–∫–∞**: –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- **–ü–æ–≤—Ç–æ—Ä–Ω–∞—è —Å–±–æ—Ä–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π**: ~90% –±—ã—Å—Ç—Ä–µ–µ
- **–°–±–æ—Ä–∫–∞ —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤ –∫–æ–¥–µ**: ~70% –±—ã—Å—Ç—Ä–µ–µ
- **–°–±–æ—Ä–∫–∞ —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π**: ~50% –±—ã—Å—Ç—Ä–µ–µ

#### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞:
- **pnpm store**: –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–µ–∂–¥—É —Å–±–æ—Ä–∫–∞–º–∏
- **Next.js cache**: –ö—ç—à–∏—Ä—É–µ—Ç—Å—è –º–µ–∂–¥—É —Å–±–æ—Ä–∫–∞–º–∏
- **Bun cache**: –ö—ç—à–∏—Ä—É–µ—Ç—Å—è –º–µ–∂–¥—É —Å–±–æ—Ä–∫–∞–º–∏
- **Prisma cache**: –ö—ç—à–∏—Ä—É–µ—Ç—Å—è –º–µ–∂–¥—É —Å–±–æ—Ä–∫–∞–º–∏

### üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:

#### Frontend –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
```dockerfile
# –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ pnpm store
RUN --mount=type=cache,id=pnpm,target=/root/.local/share/pnpm/store \
    pnpm config set store-dir /root/.local/share/pnpm/store && \
    pnpm install --frozen-lockfile --prefer-offline

# –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Next.js cache
RUN --mount=type=cache,id=nextjs,target=/app/.next/cache \
    pnpm run build
```

#### Backend –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
```dockerfile
# –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ bun cache
RUN --mount=type=cache,id=bun,target=/root/.bun/install/cache \
    bun install --frozen-lockfile

# –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Prisma cache
RUN --mount=type=cache,id=prisma,target=/root/.cache/prisma \
    bunx prisma generate --schema=./src/database/prisma/schema.prisma
```

### üìÅ .dockerignore —Ñ–∞–π–ª—ã
–°–æ–∑–¥–∞–Ω—ã –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ .dockerignore —Ñ–∞–π–ª—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –Ω–µ–Ω—É–∂–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å–±–æ—Ä–∫–∏.

### üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:

1. **–î–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `make dev-build-fast`
2. **–î–ª—è production –¥–µ–ø–ª–æ—è**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `make prod-build-fast`
3. **–ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –∫—ç—à–µ–º**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `make cache-clean`
4. **–î–ª—è –º–∞–ª–æ–º–æ—â–Ω—ã—Ö —Å–∏—Å—Ç–µ–º**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `make prod-build-sequential`

### ‚ö° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:

- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ —Å `--parallel`
- –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ–Ω—É–∂–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ .dockerignore
- –ú–Ω–æ–≥–æ—Å—Ç–∞–¥–∏–π–Ω–∞—è —Å–±–æ—Ä–∫–∞ –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–±—Ä–∞–∑–æ–≤
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ—Ä—è–¥–∫–∞ –∫–æ–º–∞–Ω–¥ –≤ Dockerfile
